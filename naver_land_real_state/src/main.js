// src/main.js
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const fs = require('fs');
const { openNaver, shutdownBrowser, detectChromePath } = require('./services/puppeteer');

const gotLock = app.requestSingleInstanceLock();
if (!gotLock) { app.quit(); process.exit(0); }
else {
    app.on('second-instance', () => {
        if (mainWindow && !mainWindow.isDestroyed()) { mainWindow.show(); mainWindow.focus(); }
    });
}

let mainWindow = null;

function createWindow() {
    mainWindow = new BrowserWindow({
        width: 920,
        height: 680,
        show: true,
        autoHideMenuBar: true,
        webPreferences: { preload: path.join(__dirname, 'preload.js'), contextIsolation: true }
    });
    mainWindow.loadFile('index.html');
}

app.whenReady().then(createWindow);
app.on('window-all-closed', () => { if (process.platform !== 'darwin') app.quit(); });
app.on('before-quit', async () => { await shutdownBrowser().catch(() => {}); });
app.on('activate', () => { if (BrowserWindow.getAllWindows().length === 0) createWindow(); });

// 로그인 Stub
ipcMain.handle('login', async (_evt, { userId, password }) => {
    const ok = Boolean((userId || '').trim() && (password || '').trim());
    return { ok, message: ok ? '로그인 성공(Stub)' : '아이디/비밀번호를 확인하세요' };
});

// 크롬 경로
ipcMain.handle('resolve-chrome-path', async () => {
    const auto = detectChromePath();
    if (auto) return { path: auto, auto: true };

    const r = await dialog.showOpenDialog({
        title: 'Chrome 실행 파일 선택',
        properties: ['openFile'],
        filters: process.platform === 'win32'
            ? [{ name: 'Executable', extensions: ['exe'] }]
            : [{ name: 'All files', extensions: ['*'] }]
    });
    if (r.canceled || !r.filePaths?.length) return { path: null, auto: false };
    return { path: r.filePaths[0], auto: false };
});

function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }
function toPlusQuery(s) { return encodeURIComponent(s).replace(/%20/g, '+'); }

// ──────────────────────────────────────────────
// 저장 유틸: 실행 경로(JSON 배열)로 매 건 즉시 저장
// ──────────────────────────────────────────────
function ensureDirSync(dir) { try { fs.mkdirSync(dir, { recursive: true }); } catch {} }
function getRunBaseDir() {
    return app.isPackaged ? path.dirname(process.execPath) : process.cwd();
}
function loadArray(filePath) {
    try {
        if (fs.existsSync(filePath)) {
            const raw = fs.readFileSync(filePath, 'utf-8');
            const json = JSON.parse(raw);
            return Array.isArray(json) ? json : [];
        }
    } catch {}
    return [];
}
function saveOneRecordIncremental(record, fileName = 'city_latlon.json') {
    const baseDir = getRunBaseDir();
    ensureDirSync(baseDir);
    const savePath = path.join(baseDir, fileName);

    // 중복 방지(시도+시군구 기준으로 최신값으로 대체하고 싶으면 on)
    const dedupeKey = (r) => `${r['시도']}|${r['시군구']}`;
    let arr = loadArray(savePath);
    const map = new Map(arr.map(r => [dedupeKey(r), r]));
    map.set(dedupeKey(record), record); // 덮어쓰기(있으면 업데이트, 없으면 추가)
    arr = Array.from(map.values());

    fs.writeFileSync(savePath, JSON.stringify(arr, null, 2), 'utf-8');
    console.log(`[SAVED:1] ${savePath} (size=${arr.length})`);
    return savePath;
}

/**
 * 도시 목록을 순회하여 lat/lon 수집
 * - 요청 전 URL 프린트, 완료 후 완료 로그 프린트
 * - 각 도시 처리 직후 실행경로에 즉시 저장(JSON 배열 유지)
 */
ipcMain.handle('open-naver', async (_evt, { exePath, gapMs = 3000, cities }) => {
    const cityList = Array.isArray(cities) && cities.length ? cities : [
        { "시도": "경기도", "시군구": "부천시 소사구" },
        { "시도": "경상남도", "시군구": "의령군" },
        { "시도": "충청남도", "시군구": "천안시 동남구" },
        { "시도": "대전시", "시군구": "대덕구" },
        { "시도": "부산시", "시군구": "서구" },
        { "시도": "강원도", "시군구": "영월군" },
        { "시도": "광주시", "시군구": "북구" },
        { "시도": "강원도", "시군구": "양구군" },
        { "시도": "전라남도", "시군구": "고흥군" },
        { "시도": "경상북도", "시군구": "울릉군" },
        { "시도": "서울시", "시군구": "양천구" },
        { "시도": "울산시", "시군구": "남구" },
        { "시도": "충청북도", "시군구": "청주시 청원구" },
        { "시도": "인천시", "시군구": "강화군" },
        { "시도": "전북도", "시군구": "전주시 덕진구" },
        { "시도": "전북도", "시군구": "고창군" },
        { "시도": "강원도", "시군구": "고성군" },
        { "시도": "인천시", "시군구": "동구" },
        { "시도": "충청북도", "시군구": "청주시 상당구" },
        { "시도": "전라남도", "시군구": "완도군" },
        { "시도": "강원도", "시군구": "태백시" },
        { "시도": "인천시", "시군구": "남동구" },
        { "시도": "전라남도", "시군구": "보성군" },
        { "시도": "경상북도", "시군구": "포항시 북구" },
        { "시도": "서울시", "시군구": "종로구" },
        { "시도": "경기도", "시군구": "성남시 수정구" },
        { "시도": "전북도", "시군구": "전주시 완산구" },
        { "시도": "경기도", "시군구": "여주시" },
        { "시도": "전북도", "시군구": "장수군" },
        { "시도": "경기도", "시군구": "수원시 장안구" },
        { "시도": "경기도", "시군구": "의정부시" },
        { "시도": "경상북도", "시군구": "의성군" },
        { "시도": "광주시", "시군구": "광산구" },
        { "시도": "대전시", "시군구": "서구" },
        { "시도": "부산시", "시군구": "동구" },
        { "시도": "서울시", "시군구": "관악구" },
        { "시도": "대구시", "시군구": "달서구" },
        { "시도": "울산시", "시군구": "북구" },
        { "시도": "경기도", "시군구": "양평군" },
        { "시도": "경기도", "시군구": "용인시 기흥구" },
        { "시도": "경기도", "시군구": "하남시" },
        { "시도": "경기도", "시군구": "용인시 처인구" },
        { "시도": "전라남도", "시군구": "영광군" },
        { "시도": "강원도", "시군구": "삼척시" },
        { "시도": "경상남도", "시군구": "고성군" },
        { "시도": "경기도", "시군구": "안양시 만안구" },
        { "시도": "경기도", "시군구": "평택시" },
        { "시도": "강원도", "시군구": "평창군" },
        { "시도": "충청남도", "시군구": "천안시 서북구" },
        { "시도": "부산시", "시군구": "해운대구" },
        { "시도": "충청북도", "시군구": "옥천군" },
        { "시도": "경기도", "시군구": "포천시" },
        { "시도": "대구시", "시군구": "서구" },
        { "시도": "경기도", "시군구": "성남시 분당구" },
        { "시도": "서울시", "시군구": "성동구" },
        { "시도": "충청북도", "시군구": "음성군" },
        { "시도": "경상북도", "시군구": "문경시" },
        { "시도": "인천시", "시군구": "부평구" },
        { "시도": "경상남도", "시군구": "창원시 성산구" },
        { "시도": "부산시", "시군구": "동래구" },
        { "시도": "대전시", "시군구": "동구" },
        { "시도": "전라남도", "시군구": "해남군" },
        { "시도": "전라남도", "시군구": "광양시" },
        { "시도": "부산시", "시군구": "부산진구" },
        { "시도": "경상북도", "시군구": "청도군" },
        { "시도": "강원도", "시군구": "홍천군" },
        { "시도": "경기도", "시군구": "연천군" },
        { "시도": "경기도", "시군구": "의왕시" },
        { "시도": "서울시", "시군구": "강북구" },
        { "시도": "경기도", "시군구": "수원시 권선구" },
        { "시도": "경상북도", "시군구": "청송군" },
        { "시도": "경기도", "시군구": "이천시" },
        { "시도": "충청북도", "시군구": "청주시 흥덕구" },
        { "시도": "경상북도", "시군구": "성주군" },
        { "시도": "경기도", "시군구": "시흥시" },
        { "시도": "강원도", "시군구": "동해시" },
        { "시도": "서울시", "시군구": "중랑구" },
        { "시도": "전라남도", "시군구": "강진군" },
        { "시도": "강원도", "시군구": "속초시" },
        { "시도": "경기도", "시군구": "오산시" },
        { "시도": "경기도", "시군구": "광주시" },
        { "시도": "경상북도", "시군구": "안동시" },
        { "시도": "강원도", "시군구": "정선군" },
        { "시도": "전북도", "시군구": "무주군" },
        { "시도": "부산시", "시군구": "남구" },
        { "시도": "서울시", "시군구": "용산구" },
        { "시도": "경상북도", "시군구": "고령군" },
        { "시도": "대구시", "시군구": "동구" },
        { "시도": "경기도", "시군구": "성남시 중원구" },
        { "시도": "경상남도", "시군구": "진주시" },
        { "시도": "서울시", "시군구": "중구" },
        { "시도": "경상남도", "시군구": "남해군" },
        { "시도": "서울시", "시군구": "강서구" },
        { "시도": "전라남도", "시군구": "장흥군" },
        { "시도": "경기도", "시군구": "안성시" },
        { "시도": "충청남도", "시군구": "보령시" },
        { "시도": "경기도", "시군구": "고양시 일산동구" },
        { "시도": "부산시", "시군구": "사상구" },
        { "시도": "전라남도", "시군구": "담양군" },
        { "시도": "경상북도", "시군구": "영양군" },
        { "시도": "대구시", "시군구": "수성구" },
        { "시도": "강원도", "시군구": "횡성군" },
        { "시도": "울산시", "시군구": "중구" },
        { "시도": "전라남도", "시군구": "구례군" },
        { "시도": "경상북도", "시군구": "경주시" },
        { "시도": "경상남도", "시군구": "하동군" },
        { "시도": "전북도", "시군구": "익산시" },
        { "시도": "부산시", "시군구": "영도구" },
        { "시도": "부산시", "시군구": "북구" },
        { "시도": "경기도", "시군구": "파주시" },
        { "시도": "충청남도", "시군구": "서산시" },
        { "시도": "충청북도", "시군구": "증평군" },
        { "시도": "경상북도", "시군구": "경산시" },
        { "시도": "서울시", "시군구": "성북구" },
        { "시도": "경상북도", "시군구": "영주시" },
        { "시도": "경기도", "시군구": "수원시 팔달구" },
        { "시도": "경상남도", "시군구": "함안군" },
        { "시도": "경상남도", "시군구": "창녕군" },
        { "시도": "부산시", "시군구": "수영구" },
        { "시도": "충청남도", "시군구": "공주시" },
        { "시도": "강원도", "시군구": "철원군" },
        { "시도": "충청북도", "시군구": "괴산군" },
        { "시도": "충청북도", "시군구": "진천군" },
        { "시도": "서울시", "시군구": "은평구" },
        { "시도": "경상남도", "시군구": "거창군" },
        { "시도": "부산시", "시군구": "연제구" },
        { "시도": "전라남도", "시군구": "나주시" },
        { "시도": "경상북도", "시군구": "구미시" },
        { "시도": "경상남도", "시군구": "밀양시" },
        { "시도": "서울시", "시군구": "동작구" },
        { "시도": "충청남도", "시군구": "아산시" },
        { "시도": "충청남도", "시군구": "홍성군" },
        { "시도": "충청남도", "시군구": "태안군" },
        { "시도": "전라남도", "시군구": "함평군" },
        { "시도": "경상북도", "시군구": "김천시" },
        { "시도": "전북도", "시군구": "남원시" },
        { "시도": "충청남도", "시군구": "논산시" },
        { "시도": "경상남도", "시군구": "통영시" },
        { "시도": "서울시", "시군구": "금천구" },
        { "시도": "서울시", "시군구": "동대문구" },
        { "시도": "전북도", "시군구": "완주군" },
        { "시도": "세종시", "시군구": "세종시" },
        { "시도": "경상북도", "시군구": "포항시 남구" },
        { "시도": "강원도", "시군구": "화천군" },
        { "시도": "대구시", "시군구": "남구" },
        { "시도": "서울시", "시군구": "도봉구" },
        { "시도": "충청남도", "시군구": "청양군" },
        { "시도": "경기도", "시군구": "군포시" },
        { "시도": "경기도", "시군구": "고양시 일산서구" },
        { "시도": "전라남도", "시군구": "목포시" },
        { "시도": "대구시", "시군구": "달성군" },
        { "시도": "경기도", "시군구": "과천시" },
        { "시도": "제주", "시군구": "서귀포시" },
        { "시도": "충청남도", "시군구": "계룡시" },
        { "시도": "경상남도", "시군구": "창원시 마산회원구" },
        { "시도": "경기도", "시군구": "부천시 원미구" },
        { "시도": "전라남도", "시군구": "장성군" },
        { "시도": "경기도", "시군구": "남양주시" },
        { "시도": "충청북도", "시군구": "제천시" },
        { "시도": "대전시", "시군구": "유성구" },
        { "시도": "강원도", "시군구": "인제군" },
        { "시도": "서울시", "시군구": "노원구" },
        { "시도": "광주시", "시군구": "서구" },
        { "시도": "전북도", "시군구": "부안군" },
        { "시도": "인천시", "시군구": "중구" },
        { "시도": "경상북도", "시군구": "영천시" },
        { "시도": "경상북도", "시군구": "상주시" },
        { "시도": "경상북도", "시군구": "영덕군" },
        { "시도": "대구시", "시군구": "북구" },
        { "시도": "경기도", "시군구": "가평군" },
        { "시도": "충청남도", "시군구": "부여군" },
        { "시도": "경상남도", "시군구": "창원시 의창구" },
        { "시도": "경기도", "시군구": "양주시" },
        { "시도": "부산시", "시군구": "기장군" },
        { "시도": "경상남도", "시군구": "창원시 마산합포구" },
        { "시도": "경상남도", "시군구": "합천군" },
        { "시도": "경상남도", "시군구": "산청군" },
        { "시도": "경상북도", "시군구": "울진군" },
        { "시도": "서울시", "시군구": "광진구" },
        { "시도": "부산시", "시군구": "중구" },
        { "시도": "경기도", "시군구": "부천시 오정구" },
        { "시도": "경상북도", "시군구": "봉화군" },
        { "시도": "전라남도", "시군구": "곡성군" },
        { "시도": "충청북도", "시군구": "보은군" },
        { "시도": "경기도", "시군구": "안산시 상록구" },
        { "시도": "경기도", "시군구": "구리시" },
        { "시도": "서울시", "시군구": "송파구" },
        { "시도": "전라남도", "시군구": "여수시" },
        { "시도": "경상북도", "시군구": "칠곡군" },
        { "시도": "경기도", "시군구": "고양시 덕양구" },
        { "시도": "서울시", "시군구": "강동구" },
        { "시도": "광주시", "시군구": "동구" },
        { "시도": "강원도", "시군구": "춘천시" },
        { "시도": "경기도", "시군구": "용인시 수지구" },
        { "시도": "서울시", "시군구": "구로구" },
        { "시도": "강원도", "시군구": "양양군" },
        { "시도": "경기도", "시군구": "동두천시" },
        { "시도": "전라남도", "시군구": "진도군" },
        { "시도": "울산시", "시군구": "울주군" },
        { "시도": "충청남도", "시군구": "서천군" },
        { "시도": "충청남도", "시군구": "금산군" },
        { "시도": "인천시", "시군구": "연수구" },
        { "시도": "제주", "시군구": "제주시" },
        { "시도": "전북도", "시군구": "정읍시" },
        { "시도": "경기도", "시군구": "광명시" },
        { "시도": "대전시", "시군구": "중구" },
        { "시도": "충청북도", "시군구": "충주시" },
        { "시도": "전라남도", "시군구": "순천시" },
        { "시도": "경상남도", "시군구": "창원시 진해구" },
        { "시도": "충청북도", "시군구": "영동군" },
        { "시도": "전북도", "시군구": "김제시" },
        { "시도": "전북도", "시군구": "순창군" },
        { "시도": "경상남도", "시군구": "함양군" },
        { "시도": "강원도", "시군구": "원주시" },
        { "시도": "서울시", "시군구": "마포구" },
        { "시도": "경기도", "시군구": "김포시" },
        { "시도": "전북도", "시군구": "군산시" },
        { "시도": "인천시", "시군구": "옹진군" },
        { "시도": "경상남도", "시군구": "양산시" },
        { "시도": "부산시", "시군구": "사하구" },
        { "시도": "전북도", "시군구": "진안군" },
        { "시도": "서울시", "시군구": "강남구" },
        { "시도": "충청남도", "시군구": "예산군" },
        { "시도": "경기도", "시군구": "화성시" },
        { "시도": "대구시", "시군구": "군위군" },
        { "시도": "부산시", "시군구": "금정구" },
        { "시도": "서울시", "시군구": "서대문구" },
        { "시도": "울산시", "시군구": "동구" },
        { "시도": "전북도", "시군구": "임실군" },
        { "시도": "대구시", "시군구": "중구" },
        { "시도": "충청남도", "시군구": "당진시" },
        { "시도": "충청북도", "시군구": "청주시 서원구" },
        { "시도": "강원도", "시군구": "강릉시" },
        { "시도": "경기도", "시군구": "안양시 동안구" },
        { "시도": "인천시", "시군구": "미추홀구" },
        { "시도": "경상남도", "시군구": "거제시" },
        { "시도": "인천시", "시군구": "계양구" },
        { "시도": "경상남도", "시군구": "사천시" },
        { "시도": "광주시", "시군구": "남구" },
        { "시도": "전라남도", "시군구": "영암군" },
        { "시도": "전라남도", "시군구": "신안군" },
        { "시도": "전라남도", "시군구": "무안군" },
        { "시도": "서울시", "시군구": "영등포구" },
        { "시도": "경기도", "시군구": "수원시 영통구" },
        { "시도": "전라남도", "시군구": "화순군" },
        { "시도": "경상북도", "시군구": "예천군" },
        { "시도": "인천시", "시군구": "서구" },
        { "시도": "경상남도", "시군구": "김해시" },
        { "시도": "부산시", "시군구": "강서구" },
        { "시도": "충청북도", "시군구": "단양군" },
        { "시도": "서울시", "시군구": "서초구" },
        { "시도": "경기도", "시군구": "안산시 단원구" }
    ];

    const results = []; // 실행 중 콘솔 출력용(파일 저장은 매 건 즉시 수행)

    for (const item of cityList) {
        const sido = (item['시도'] || '').trim();
        const sigungu = (item['시군구'] || '').trim();
        if (!sido || !sigungu) continue;

        const query = `${sido} ${sigungu}`;
        const url = `https://fin.land.naver.com/search?q=${toPlusQuery(query)}`;

        console.log(`[REQ] ${url}`);
        try {
            const { status, finalUrl, lat, lon } = await openNaver(exePath, url);
            console.log(`[DONE] status=${status} final=${finalUrl}`);

            const record = { "시도": sido, "시군구": sigungu, "lat": lat ?? "", "lon": lon ?? "" };
            results.push(record);

            // ✅ 매 건 즉시 저장
            saveOneRecordIncremental(record);
        } catch (e) {
            console.error(`[ERROR] ${query}:`, e?.message || e);
            const record = { "시도": sido, "시군구": sigungu, "lat": "", "lon": "" };
            results.push(record);

            // 실패 건도 저장하려면 유지 (생략하려면 이 줄 제거)
            saveOneRecordIncremental(record);
        }

        await sleep(gapMs);
    }

    console.log('=== 최종 결과(세션 메모리) ===');
    console.log(JSON.stringify(results, null, 2));

    return { ok: true, count: results.length, savedAt: path.join(getRunBaseDir(), 'city_latlon.json') };
});
